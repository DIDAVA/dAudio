/*!
 * dAudio.js v1.0.0
 * (c) 2019 DIDAVA Media
 * Released under the MIT License.
 * https://www.didava.ir
 * https://github.com/DIDAVA/dAudio
 */
function dAudio(e=null){let t=null,o=null,n=0,a=0,r=null,u=null,i=0,l=[],s=1,p=0,c=1,d=40,f="boolean"!=typeof e.remaster||e.remaster,y="string"==typeof e.src?e.src:"",h="boolean"==typeof e.autoplay&&e.autoplay,m="boolean"==typeof e.repeat&&e.repeat;["state","init","load","offline","online","decode","remaster","ready","play","pause","stop","end","autoplay","repeat","error"].forEach(t=>{const o=`on${t}`;"function"==typeof e[o]&&(this[o]=e[o])});const b=(e,t=0,n="OK")=>{o=e;const a={name:e,code:t,message:n};"function"==typeof this.onstate&&this.onstate(a),"function"==typeof this[`on${e}`]&&this[`on${e}`](a),"ready"===e&&h&&(b("autoplay"),N()),"end"===e&&m&&(b("repeat"),N())};b("init"),["function"==typeof AudioContext,"function"==typeof AudioBufferSourceNode,"function"==typeof AudioDestinationNode,"function"==typeof GainNode,"function"==typeof DynamicsCompressorNode].includes(!1)&&b("error",1,"Incompatible Browser");const g=()=>u.match(/^audio\/[a-z0-9]+$/),v=()=>i>0,A=(e,t,o)=>(e>o?e=o:e<t&&(e=t),e),E=new AudioContext,C=E.createGain(),F=E.createDynamicsCompressor();F.attack.value=1,F.release.value=.25,F.threshold.value=0,F.ratio.value=1,F.knee.value=40,l.push(C,F),Object.defineProperty(this,"eq",{enumerable:!0,writable:!0,configurable:!0,value:{}});const D=[31,63,125,250,500,1e3,2e3,4e3,8e3,12e3,16e3,2e4];D.forEach((e,t)=>{const o=E.createBiquadFilter();0==t?o.type="lowshelf":t==D.length-1?o.type="highshelf":o.type="peaking",o.frequency.value=e,Object.defineProperty(this.eq,e.toString().replace(/000$/,"k")+"Hz",{enumerable:!0,get:()=>o.gain.value,set(e){"number"==typeof e&&(o.gain.value=A(e,-12,3))}}),l.push(o)});const k=E.createGain();l.push(k,E.destination),l.forEach((e,t)=>{0!=t&&l[t-1].connect(e)});const M=e=>{b("decode"),E.decodeAudioData(e,e=>{r=e,q()},e=>b("error",2,"Unsupported Audio Codec"))},T=e=>{C.gain.value=e?s:1,F.threshold.value=e?p:0,F.ratio.value=e?c:1,F.knee.value=e?d:40,f=e},q=()=>{b("remaster");let e=0,t=0,o=0,n=r.numberOfChannels;for(let o=0;o<n;o++)r.getChannelData(o).forEach(o=>{e+=o>0?o:-o,o>t?t=o:-o>t&&(t=-o)});o=e/(r.length/n),s=parseFloat((2-t).toFixed(2)),p=Math.floor(A(-50*(1-o),-100,0)),c=Math.ceil(A(20-20*o,1,20)),d=Math.floor(A(40-15*o,0,40)),T(f),H(!0),b("ready")},w=()=>a||(n?E.currentTime-n:0),B=()=>{t.stop(),t.disconnect(C),t=null},H=(e=!1)=>{e||b("stop"),t&&B(),n=0,a=0},I=(e=!1)=>{t&&(e||b("pause"),B(),a=E.currentTime-n)},N=(e=!1)=>{!t&&r&&(e||b("play"),(t=E.createBufferSource()).connect(C),t.buffer=r,t.start(0,a),n=E.currentTime-a,a=0,t.onended=()=>{w()>=r.duration&&(H(),b("end"))})};Object.defineProperties(dAudio.prototype,{state:{enumerable:!0,get:()=>o},src:{enumerable:!0,get:()=>y,set(e){(e=>{b("load");if(e instanceof File)b("offline"),y=e.name,u=e.type,i=e.size,g()&&v()?e.arrayBuffer().then(e=>M(e)):b("error",3,"Invalid Audio File");else if("string"==typeof e){b("online");const t=new XMLHttpRequest;t.responseType="arraybuffer",t.onreadystatechange=()=>{t.status>=400?(t.abort(),b("error",4,"Audio File Not Found")):t.readyState===t.HEADERS_RECEIVED&&(u=t.getResponseHeader("content-type"),i=parseInt(t.getResponseHeader("content-length")),g()&&v()||(t.abort(),b("error",3,"Invalid Audio File")))},t.onload=()=>{y=e,M(t.response)},t.open("GET",e,!0),t.send()}})(e)}},type:{enumerable:!0,get:()=>u},size:{enumerable:!0,get:()=>i},duration:{enumerable:!0,get:()=>r?r.duration:0},currentTime:{enumerable:!0,get:()=>w(),set(e){var o;"number"==typeof e&&(o=A(e,0,this.duration),b("seek"),t?(I(!0),a=o,N(!0)):a=o)}},isPlaying:{enumerable:!0,get:()=>!!t},repeat:{enumerable:!0,get:()=>m,set(e){"boolean"==typeof e&&(m=e)}},autoplay:{enumerable:!0,get:()=>h,set(e){"boolean"==typeof e&&(h=e)}},remaster:{enumerable:!0,get:()=>f,set(e){"boolean"==typeof e&&T(e)}},volume:{enumerable:!0,get:()=>(e=>.43429*Math.log(e)*20)(k.gain.value),set(e){"number"==typeof e&&(k.gain.value=(e=>Math.exp(e/8.6858))(A(e,-100,0)))}}}),dAudio.prototype.play=function(){N()},dAudio.prototype.pause=function(){I()},dAudio.prototype.stop=function(){H()},dAudio.prototype.playPause=function(){t?I():N()},y&&(this.src=y)}